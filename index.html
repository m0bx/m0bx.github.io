<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mobx</title>
  <link rel="stylesheet" href="resources/style.css" />
</head>
<body>
  <main class="app">
    <h1 class="typewriter" aria-label="mobx">
      <span id="typed-text"></span><span class="cursor" aria-hidden="true">_</span>
    </h1>

    <section class="card">
      <div id="image-wrap" class="image-wrap is-loading" aria-busy="true">
        <div class="skeleton" aria-hidden="true"></div>
        <img class="loader-gif" src="resources/skeleton.gif" alt="" aria-hidden="true" />

        <img
          id="capy-img"
          src=""
          alt="Random capybara"
          class="capy-img"
        />
      </div>

      <p id="status" class="status">Loading capybara...</p>

      <div id="fact-box" class="fact-box" aria-live="polite">
        <p class="fact-label">Capy Fact</p>
        <p id="capy-fact" class="fact-text">Loading a capybara fact...</p>
      </div>

      <button id="new-capy-btn" class="btn" type="button">
        Get Another Capybara
      </button>
    </section>
  </main>
<script>
  const typedText = document.getElementById("typed-text");
  const capyImg = document.getElementById("capy-img");
  const statusEl = document.getElementById("status");
  const factEl = document.getElementById("capy-fact");
  const button = document.getElementById("new-capy-btn");
  const imageWrap = document.getElementById("image-wrap");

  // --- Typewriter animation (mobx) ---
  const word = "mobx";
  const TYPE_SPEED = 120;
  const ERASE_SPEED = 80;
  const TYPEWRITER_CYCLE_MS = 5000;

  const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

  async function runTypewriterLoop() {
    while (true) {
      typedText.textContent = "";

      for (const char of word) {
        typedText.textContent += char;
        await sleep(TYPE_SPEED);
      }

      const usedMs = word.length * TYPE_SPEED + word.length * ERASE_SPEED;
      const holdMs = Math.max(300, TYPEWRITER_CYCLE_MS - usedMs);

      await sleep(holdMs);

      while (typedText.textContent.length > 0) {
        typedText.textContent = typedText.textContent.slice(0, -1);
        await sleep(ERASE_SPEED);
      }

      await sleep(120);
    }
  }

  function setLoadingUI(isLoading, imageReady = false) {
    if (isLoading) {
      imageWrap.classList.add("is-loading");
      imageWrap.classList.remove("is-loaded");
    } else {
      imageWrap.classList.remove("is-loading");
      if (imageReady) {
        // Trigger fade-in after skeleton/spinner start fading out
        requestAnimationFrame(() => {
          imageWrap.classList.add("is-loaded");
        });
      } else {
        imageWrap.classList.remove("is-loaded");
      }
    }

    imageWrap.setAttribute("aria-busy", String(isLoading));
    button.disabled = isLoading;
  }

  function preloadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(url);
      img.onerror = reject;
      img.src = url;
    });
  }

  async function fetchRandomCapybara() {
    const res = await fetch("https://api.capy.lol/v1/capybara?json=true", {
      cache: "no-store",
    });

    if (!res.ok) throw new Error(`Image HTTP ${res.status}`);

    const json = await res.json();
    const data = json?.data;

    if (!data?.url) throw new Error("Missing image URL");

    const imageUrl = data.url.replace(/^http:\/\//i, "https://");
    await preloadImage(imageUrl);

    capyImg.src = imageUrl;
    capyImg.alt = data.alt || "Random capybara";

    statusEl.textContent = `Capy #${data.index ?? "?"}`;
  }

  async function fetchCapyFact() {
    const res = await fetch("https://api.capy.lol/v1/fact", {
      cache: "no-store",
    });

    if (!res.ok) throw new Error(`Fact HTTP ${res.status}`);

    const json = await res.json();
    const fact = json?.data?.fact;

    if (!fact) throw new Error("Missing fact text");

    factEl.textContent = fact;
  }

  async function loadContent() {
    let imageLoaded = false;

    setLoadingUI(true);
    statusEl.textContent = "Fetching a capybara...";
    factEl.textContent = "Loading a capybara fact...";

    try {
      const [imageResult, factResult] = await Promise.allSettled([
        fetchRandomCapybara(),
        fetchCapyFact(),
      ]);

      if (imageResult.status === "rejected") {
        console.error(imageResult.reason);
        statusEl.textContent = "Could not load capybara image. Try again.";
        capyImg.alt = "Failed to load capybara image";
      } else {
        imageLoaded = true;
      }

      if (factResult.status === "rejected") {
        console.error(factResult.reason);
        factEl.textContent = "Could not load a capybara fact this time.";
      }
    } finally {
      setLoadingUI(false, imageLoaded);
    }
  }

  button.addEventListener("click", loadContent);

  window.addEventListener("DOMContentLoaded", () => {
    runTypewriterLoop();
    loadContent();
  });
</script>
</body>
</html>
